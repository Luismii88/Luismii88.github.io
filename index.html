<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b1220">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NutriApp">

<title>NutriApp</title>

<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon-512.PNG">

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system, BlinkMacSystemFont, sans-serif;
  background:#0b1220;
  color:white;
}
.hidden{display:none;}
.container{padding:20px;}
.card{
  background:#111827;
  padding:20px;
  border-radius:20px;
  margin-bottom:20px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  margin-top:10px;
  background:#22c55e;
  color:white;
  font-weight:600;
}
button.secondary{background:#374151;}
.topnav{
  display:flex;
  justify-content:space-around;
  background:#0b1220;
  border-bottom:1px solid #1f2937;
}
.topnav button{
  flex:1;
  background:none;
  color:#9ca3af;
}
.topnav button.active{
  color:#22c55e;
  font-weight:700;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  border:1px solid #1f2937;
  padding:6px;
}
input, select, textarea{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:10px;
  border:none;
}
.compra-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:8px 0;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="container">
  <div class="card">
    <h2>NutriApp</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Contraseña">
    <button id="loginBtn">Entrar</button>
    <button id="registerBtn" class="secondary">Crear cuenta</button>
    <button id="googleBtn" class="secondary">Entrar con Google</button>
    <p id="loginError" style="color:red;"></p>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">

<div class="topnav">
  <button id="tabHome" class="active">Home</button>
  <button id="tabPlan">Plan</button>
  <button id="tabCompra">Compra</button>
  <button id="logoutBtn">Salir</button>
</div>

<!-- HOME -->
<div id="home" class="container">
  <div class="card">
    <select id="perfilHome">
      <option value="Natalia">Natalia</option>
      <option value="Luismi">Luismi</option>
    </select>
    <div id="tablaSemanal"></div>
  </div>
</div>

<!-- PLAN -->
<div id="plan" class="container hidden">
  <div class="card">
    <select id="perfil">
      <option value="Natalia">Natalia</option>
      <option value="Luismi">Luismi</option>
    </select>
    <select id="dia"></select>
    <textarea id="desayuno" placeholder="Desayuno"></textarea>
    <textarea id="comida" placeholder="Comida"></textarea>
    <textarea id="cena" placeholder="Cena"></textarea>
    <button id="guardarBtn">Guardar</button>
  </div>
</div>

<!-- COMPRA -->
<div id="compra" class="container hidden">
  <div class="card">
    <h3>Lista de la Compra</h3>
    <div id="listaCompra"></div>
  </div>
</div>

</div>

<script>

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyCaQq-aQ5kj2TdvccyejdjNTcZvViKIncY",
  authDomain: "nutriapp-2eeb3.firebaseapp.com",
  projectId: "nutriapp-2eeb3",
  storageBucket: "nutriapp-2eeb3.firebasestorage.app",
  messagingSenderId: "7989666043",
  appId: "1:7989666043:web:97c20b6a3c963703d4105e"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

auth.useDeviceLanguage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

// ===== VARIABLES =====
const dias = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
const diaEl = document.getElementById("dia");
dias.forEach(d => diaEl.innerHTML += `<option>${d}</option>`);

// ===== AUTH =====
auth.onAuthStateChanged(async (user) => {
  if (user) {
    loginScreen.classList.add("hidden");
    app.classList.remove("hidden");
    await loadPlan();
  } else {
    loginScreen.classList.remove("hidden");
    app.classList.add("hidden");
  }
});

loginBtn.onclick = () => {
  auth.signInWithEmailAndPassword(email.value,password.value)
  .catch(e => loginError.innerText = e.message);
};

registerBtn.onclick = () => {
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .catch(e => loginError.innerText = e.message);
};

googleBtn.onclick = async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });
  try {
    await auth.signInWithPopup(provider);
  } catch (error) {
    loginError.innerText = error.message;
  }
};

logoutBtn.onclick = () => auth.signOut();

// ===== NAVEGACIÓN =====
function activarTab(tab){
  document.querySelectorAll(".topnav button").forEach(b=>b.classList.remove("active"));
  home.classList.add("hidden");
  plan.classList.add("hidden");
  compra.classList.add("hidden");

  if(tab==="home"){ tabHome.classList.add("active"); home.classList.remove("hidden"); }
  if(tab==="plan"){ tabPlan.classList.add("active"); plan.classList.remove("hidden"); }
  if(tab==="compra"){ tabCompra.classList.add("active"); compra.classList.remove("hidden"); renderListaCompra(); }
}

tabHome.onclick = ()=>activarTab("home");
tabPlan.onclick = ()=>activarTab("plan");
tabCompra.onclick = ()=>activarTab("compra");

// ===== PLAN =====
async function savePlan(){
  const user = auth.currentUser;
  await db.collection("plans").doc(user.uid).set({
    [perfil.value + dia.value]: {
      Desayuno: desayuno.value,
      Comida: comida.value,
      Cena: cena.value
    }
  },{merge:true});
  loadPlan();
}
guardarBtn.onclick = savePlan;

async function loadPlan(){
  const user = auth.currentUser;
  if(!user) return;
  const doc = await db.collection("plans").doc(user.uid).get();
  renderHome(doc.exists ? doc.data() : {});
}

function renderHome(data={}){
  let perfilSel = perfilHome.value;
  let html="<table><tr><th></th>";
  dias.forEach(d=> html+=`<th>${d}</th>`);
  html+="</tr>";
  ["Desayuno","Comida","Cena"].forEach(tipo=>{
    html+=`<tr><th>${tipo}</th>`;
    dias.forEach(d=>{
      let key=perfilSel+d;
      html+=`<td>${data[key]?data[key][tipo]:""}</td>`;
    });
    html+="</tr>";
  });
  html+="</table>";
  tablaSemanal.innerHTML=html;
}
perfilHome.onchange=loadPlan;

// ===== LISTA COMPRA =====
const listaBase = [
"Pechuga de pollo","Salmón","Ternera magra","Huevos",
"Claras líquidas","Arroz","Patata","Boniato",
"Verdura variada","Fruta variada","Kéfir",
"Frutos secos","Pan integral","Tortitas arroz"
];

async function renderListaCompra(){
  const doc = await db.collection("compra").doc("lista").get();
  const datos = doc.exists ? doc.data() : {};
  let html="";
  listaBase.forEach(item=>{
    const checked = datos[item] ? "checked" : "";
    html += `<div class="compra-item">
      <span>${item}</span>
      <input type="checkbox" ${checked} onchange="toggleItem('${item}')">
    </div>`;
  });
  listaCompra.innerHTML=html;
}

async function toggleItem(item){
  const ref=db.collection("compra").doc("lista");
  const doc=await ref.get();
  const datos=doc.exists?doc.data():{};
  await ref.set({[item]:!datos[item]},{merge:true});
  renderListaCompra();
}

// SERVICE WORKER
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}

</script>

</body>
</html>
