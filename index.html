<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NutriApp</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:-apple-system;background:#0b1220;color:white;}
.hidden{display:none;}
.container{padding:20px;}
.card{background:#111827;padding:20px;border-radius:20px;margin-bottom:20px;}
button{width:100%;padding:12px;border:none;border-radius:12px;margin-top:8px;background:#22c55e;color:white;font-weight:600;}
button.secondary{background:#374151;}
.topnav{display:flex;background:#0b1220;border-bottom:1px solid #1f2937;}
.topnav button{flex:1;background:none;color:#9ca3af;}
.topnav button.active{color:#22c55e;font-weight:700;}
select,textarea,input{width:100%;margin-top:8px;padding:8px;border-radius:8px;border:none;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th,td{border:1px solid #1f2937;padding:6px;text-align:center;vertical-align:top;}
.compra-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 0;
  border-bottom:1px solid #1f2937;
  width:100%;
}

.compra-item span{
  flex:1;
  text-align:left;
}

.compra-item input{
  margin-left:15px;
  transform:scale(1.2);
}
</style>
</head>
<body>

<div id="loginScreen" class="container">
<div class="card">
<h2>NutriApp</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contrase침a">
<button id="loginBtn">Entrar</button>
<button id="googleBtn" class="secondary">Entrar con Google</button>
<p id="loginError" style="color:red;"></p>
</div>
</div>

<div id="app" class="hidden">

<div class="topnav">
<button id="tabHome" class="active">Home</button>
<button id="tabEditar">Editar</button>
<button id="tabCompra">Compra</button>
<button id="logoutBtn">Salir</button>
</div>

<!-- HOME -->
<div id="home" class="container">
<select id="perfilHome">
<option value="Luismi">Luismi</option>
<option value="Natalia">Natalia</option>
</select>
<div id="tablaResumen"></div>
</div>

<!-- EDITAR -->
<div id="editar" class="container hidden">
<div class="card">
<select id="perfilEditar">
<option value="Luismi">Luismi</option>
<option value="Natalia">Natalia</option>
</select>
<select id="diaEditar"></select>
<textarea id="desayuno" placeholder="Desayuno"></textarea>
<textarea id="comida" placeholder="Comida"></textarea>
<textarea id="cena" placeholder="Cena"></textarea>
<button onclick="guardarPlan()">Guardar</button>
</div>
</div>

<!-- COMPRA -->
<div id="compra" class="container hidden">
<div class="card">
<h3>Compra autom치tica</h3>
<div id="listaAuto"></div>
<h3 style="margin-top:20px;">Extras</h3>
<div id="listaExtras"></div>
<input type="text" id="nuevoExtra" placeholder="A침adir extra">
<button onclick="addExtra()">A침adir</button>
</div>
</div>

</div>

<script>

// FIREBASE
const firebaseConfig={
apiKey:"AIzaSyCaQq-aQ5kj2TdvccyejdjNTcZvViKIncY",
authDomain:"nutriapp-2eeb3.firebaseapp.com",
projectId:"nutriapp-2eeb3"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

const dias=["Lunes","Martes","Mi칠rcoles","Jueves","Viernes","S치bado","Domingo"];
dias.forEach(d=>diaEditar.innerHTML+=`<option>${d}</option>`);

// 游댠 TU MEN칔 PRECARGADO
const menuInicial = {
Luismi:{
Lunes:{
Desayuno:`250 g queso fresco batido\n80 g avena\n30 g whey\n15 g crema cacahuete\n1 pl치tano`,
Comida:`220 g pechuga pollo\n100 g arroz crudo\n250 g verduras\n10 g AOVE`,
Cena:`200 g salm칩n\n300 g calabac칤n\n200 g patata`
},
Martes:{
Desayuno:`Igual lunes`,
Comida:`220 g ternera\n400 g patata\n250 g espinaca`,
Cena:`3 huevos\n200 g claras\n250 g verduras\n150 g queso fresco\n60 g pan`
},
Mi칠rcoles:{
Desayuno:`Igual lunes`,
Comida:`220 g pavo\n100 g couscous\n250 g verduras`,
Cena:`220 g carne picada\n2 pitas integrales\n200 g verduras\n30 g tomate`
},
Jueves:{
Desayuno:`Igual lunes`,
Comida:`220 g salm칩n\n90 g arroz\n250 g verduras`,
Cena:`400 ml crema calabac칤n\n200 g pollo\n60 g pan`
},
Viernes:{
Desayuno:`Igual lunes`,
Comida:`90 g lenteja cruda\n180 g pollo\n250 g verduras`,
Cena:`220 g pescado blanco\n300 g patata\n250 g verduras`
},
S치bado:{
Desayuno:`Igual lunes`,
Comida:`250 g carne\n350 g boniato\n250 g verduras`,
Cena:`3 huevos\n200 g gambas\n250 g esp치rragos\n60 g pan`
},
Domingo:{
Desayuno:`Igual lunes`,
Comida:`110 g arroz\n3 huevos\n200 g gambas\n250 g verduras`,
Cena:`400 ml crema\n200 g pavo\npan`
}
},
Natalia:{
Lunes:{
Desayuno:`60 g avena\n200 ml leche\n20 g whey\n15 g nueces\n췋 pl치tano`,
Comida:`130 g pollo\n70 g arroz crudo\n200 g verduras\n10 g AOVE`,
Cena:`140 g salm칩n\n250 g calabac칤n\n150 g patata`
},
Martes:{
Desayuno:`Igual lunes`,
Comida:`120 g ternera\n300 g patata\n200 g espinaca`,
Cena:`2 huevos\n150 g claras\n200 g calabac칤n\n100 g queso fresco`
},
Mi칠rcoles:{
Desayuno:`Igual lunes`,
Comida:`130 g pavo\n70 g couscous\n200 g verduras`,
Cena:`120 g carne picada\n1 pita integral\n150 g verduras\n20 g tomate`
},
Jueves:{
Desayuno:`Igual lunes`,
Comida:`140 g salm칩n\n60 g arroz\n200 g verduras`,
Cena:`350 ml crema calabac칤n\n120 g pollo`
},
Viernes:{
Desayuno:`Igual lunes`,
Comida:`60 g lenteja\n100 g pollo\n200 g verduras`,
Cena:`140 g dorada\n200 g patata\n200 g verduras`
},
S치bado:{
Desayuno:`Igual lunes`,
Comida:`130 g carne\n250 g boniato\n200 g verduras`,
Cena:`2 huevos\n120 g gambas\n200 g esp치rragos`
},
Domingo:{
Desayuno:`Igual lunes`,
Comida:`70 g arroz\n2 huevos\n120 g gambas\n200 g verduras`,
Cena:`350 ml crema\n120 g pavo`
}
}
};

// Cargar men칰 si no existe en Firestore
async function inicializarMenu(){
for(let perfil in menuInicial){
for(let dia in menuInicial[perfil]){
const ref=db.collection("planes").doc(perfil+"_"+dia);
const doc=await ref.get();
if(!doc.exists){
await ref.set(menuInicial[perfil][dia]);
}
}
}
}

// HOME
async function renderHome(){
const perfil=perfilHome.value;
let html="<table><tr><th></th>";
dias.forEach(d=>html+=`<th>${d}</th>`);
html+="</tr>";
for(let tipo of ["Desayuno","Comida","Cena"]){
html+=`<tr><th>${tipo}</th>`;
for(let dia of dias){
const doc=await db.collection("planes").doc(perfil+"_"+dia).get();
html+=`<td>${doc.exists?doc.data()[tipo]||"":""}</td>`;
}
html+="</tr>";
}
html+="</table>";
tablaResumen.innerHTML=html;
}
perfilHome.onchange = () => {
  renderHome();
  renderCompra();
};

// EDITAR
async function guardarPlan(){

  const perfil = perfilEditar.value;
  const dia = diaEditar.value;

  const ref = db.collection("planes").doc(perfil+"_"+dia);

  let updates = {};

  if(desayuno.value.trim() !== "")
    updates.Desayuno = desayuno.value;

  if(comida.value.trim() !== "")
    updates.Comida = comida.value;

  if(cena.value.trim() !== "")
    updates.Cena = cena.value;

  await ref.set(updates, { merge: true });

  renderHome();
  alert("Guardado correctamente");

}

async function cargarPlanEnEditor(){

  const perfil = perfilEditar.value;
  const dia = diaEditar.value;

  const doc = await db.collection("planes")
                      .doc(perfil + "_" + dia)
                      .get();

  if(doc.exists){
    desayuno.value = doc.data().Desayuno || "";
    comida.value   = doc.data().Comida   || "";
    cena.value     = doc.data().Cena     || "";
  } else {
    desayuno.value = "";
    comida.value   = "";
    cena.value     = "";
  }

}

perfilEditar.onchange = cargarPlanEnEditor;
diaEditar.onchange = cargarPlanEnEditor;
  
// COMPRA
async function renderCompra(){

  const perfil = perfilHome.value;
  let suma = {};

  // 游댳 Sumar gramos autom치ticamente
  for(let dia of dias){
    const doc = await db.collection("planes").doc(perfil+"_"+dia).get();
    if(doc.exists){
      for(let tipo of ["Desayuno","Comida","Cena"]){
        let texto = doc.data()[tipo] || "";
        texto.split("\n").forEach(l=>{
          let m = l.match(/(\d+)\s*g\s*(.+)/i);
          if(m){
            let gramos = parseInt(m[1]);
            let alimento = m[2].trim().toLowerCase();
            suma[alimento] = (suma[alimento]||0) + gramos;
          }
        });
      }
    }
  }

  const checksRef = db.collection("checks").doc("compra_"+perfil);
  const checksDoc = await checksRef.get();
  const checks = checksDoc.exists ? checksDoc.data() : {};

  let html = "";

  for(let item in suma){

    let cantidad = suma[item];
    let textoCantidad = cantidad >= 1000 
      ? (cantidad/1000).toFixed(2)+" kg"
      : cantidad+" g";

    let checked = checks[item] ? "checked" : "";

    html += `
      <div class="compra-item">
        <span>${item} - ${textoCantidad}</span>
        <input type="checkbox" ${checked} 
          onchange="toggleCheck('${item}')">
      </div>
    `;
  }

  listaAuto.innerHTML = html;
}

async function toggleCheck(item){

  const perfil = perfilHome.value;
  const ref = db.collection("checks").doc("compra_"+perfil);

  const doc = await ref.get();
  let data = doc.exists ? doc.data() : {};

  data[item] = !data[item];

  await ref.set(data);

}

// NAV
function activar(tab){
document.querySelectorAll(".topnav button").forEach(b=>b.classList.remove("active"));
home.classList.add("hidden");
editar.classList.add("hidden");
compra.classList.add("hidden");
if(tab==="home"){tabHome.classList.add("active");home.classList.remove("hidden");}
if(tab==="editar"){tabEditar.classList.add("active");editar.classList.remove("hidden");}
if(tab==="compra"){tabCompra.classList.add("active");compra.classList.remove("hidden");renderCompra();}
}
tabHome.onclick=()=>activar("home");
tabEditar.onclick=()=>activar("editar");
tabCompra.onclick=()=>activar("compra");

auth.onAuthStateChanged(async user=>{
if(user){
loginScreen.classList.add("hidden");
app.classList.remove("hidden");
await inicializarMenu();
renderHome();
}
});

loginBtn.onclick=()=>auth.signInWithEmailAndPassword(email.value,password.value);
googleBtn.onclick=async()=>{const provider=new firebase.auth.GoogleAuthProvider();await auth.signInWithPopup(provider);};
logoutBtn.onclick=()=>auth.signOut();

</script>

</body>
</html>
